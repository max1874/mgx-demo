# PLAN.md: AI 协同开发平台 - 开发路线图 (v2.0 - 增强版)

**版本说明**: 本文档是 v1.0 的修订版。它基于 v1.0 的优秀结构，并根据工程实践审查建议进行了强化，主要补充了关于**持续提示工程 (P.1)**、**状态机编排 (M3.3)**、**成本警示 (M4.3.5)** 和 **Bug 修复上下文 (M4.6)** 的具体任务，以提高计划的鲁棒性和可行性。

## 1.0 核心原则与技术栈

### 1.1 核心原则

1. **LLM 辅助开发 (LLM-First Development)**: 计划中的任务被设计为适合 LLM 理解和执行的单元。
2. **迭代与增量 (Iterative & Incremental)**: 从最小可用的单智能体聊天开始，逐步增加多智能体、高级模式和社区功能。

### 1.2 技术栈假设 (Tech Stack Assumption)

- **前端 (Frontend)**: React (Vite) + Tailwind CSS。
- **后端 (Backend)**: Node.js (Express.js)。
- **数据库 (Database)**: Firestore (用于实时聊天、项目数据)。
- **状态管理 (State Management)**: React Context 或 Zustand (保持简洁)。
- **LLM API**: 接入一个或多个外部大语言模型服务（如 Gemini API）。

### 1.3 并行核心任务 (Parallel Core Tasks)

以下任务不属于某个特定里程碑，而是**贯穿整个项目生命周期**的持续性工作。

| 任务 ID | 任务名称           | 描述                                                         | 关键产出           |
| ------- | ------------------ | ------------------------------------------------------------ | ------------------ |
| **P.1** | **持续的提示工程** | **[高优先级]** 这不是一次性任务。需成立专门小组，建立“Prompt 库”并进行版本控制。持续根据用户反馈和 `P.2` 的评测结果，迭代优化所有智能体 (Mike, Emma...) 的 System Prompt。 | Prompt 版本库      |
| **P.2** | **评测与日志**     | 实现对所有 LLM I/O 的结构化日志记录。建立一套评测标准（如代码生成质量、任务理解准确率），用于 `P.1` 的提示优化和模型选型。 | 日志看板与评测报告 |

## 2.0 开发里程碑 (Development Milestones)

- **M1: MVP 核心 - 单智能体聊天与项目工作区**
  - *目标*: 搭建基础的聊天应用，用户可以与一个“工程师”智能体对话并创建项目。
- **M2: “所见即所得” - 代码生成与实时预览**
  - *目标*: 实现 AI 生成代码（HTML/CSS/JS）并在“App Viewer”中实时渲染预览。
- **M3: “AI 团队” - 多智能体协同框架**
  - *目标*: 引入“团队模式”，实现多个 AI 智能体（Mike, Emma, Bob...）的协同工作流。
- **M4: “高级能力” - 专业模式与核心集成**
  - *目标*: 开发“深度研究”、“竞速模式”以及与 GitHub 和 Supabase 的关键集成。
- **M5: “社区生态” - App World 与分享**
  - *目标*: 构建社区功能，允许用户分享、发现和“改造 (Remix)”项目。
- **M6: “正式上线” - 优化与商业化**
  - *目标*: 实现积分/订阅系统、优化 Bug 修复和生产环境优化。

## 3.0 详细任务拆解 (Detailed Task Breakdown)

### M1: MVP 核心 - 单智能体聊天与项目工作区

*目标: 搭建基础的聊天应用，用户可以与一个“工程师”智能体对话并创建项目。*

| 任务 ID | 任务名称                  | 描述                                                         | 关键产出                           |
| ------- | ------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| M1.1    | 环境搭建                  | 初始化 Vite + React + Tailwind 前端项目和 Node.js + Express 后端项目。 | 可运行的 `Hello World` 前后端      |
| M1.2    | 数据库 Schema (Firestore) | 定义核心集合：`users` (用户信息), `projects` (项目元数据), `chats` (聊天记录)。 | Firestore 规则和数据结构文档       |
| M1.3    | 核心 UI - 聊天界面        | 创建 `ChatWindow` React 组件，包括消息列表（区分用户和 AI）和 `ChatInput`（带发送按钮）。 | React 组件 (`ChatWindow.jsx`)      |
| M1.4    | 核心 UI - 工作区布局      | 创建应用主布局：一个可调整大小的侧边栏（用于未来的项目列表）和一个主聊天区。 | React 组件 (`WorkspaceLayout.jsx`) |
| M1.5    | 后端 API - LLM 调用       | 创建 `/api/chat` 终端，接收用户 prompt，调用外部 LLM API，然后将流式或完整响应返回给前端。 | `chatController.js`                |
| M1.6    | “工程师模式” (v1.0)       | 为 "Alex (工程师)" 定义 **v1.0** 系统提示 (System Prompt)。连接 M1.3 的 UI 到 M1.5 的 API。 (持续优化见 P.1) | 可交互的、能与“工程师”聊天的界面   |
| M1.7    | 项目创建与切换            | 在侧边栏实现基础的项目列表，允许用户创建新项目（即新的聊天会话）和切换项目。 | UI 功能                            |

### M2: “所见即所得” - 代码生成与实时预览

*目标: 实现 AI 生成代码（HTML/CSS/JS）并在“App Viewer”中实时渲染预览。*

| 任务 ID | 任务名称               | 描述                                                         | 关键产出                     |
| ------- | ---------------------- | ------------------------------------------------------------ | ---------------------------- |
| M2.1    | UI - "App Viewer" 组件 | 在工作区布局中添加一个新面板（App Viewer）。使用 `iframe` 来安全地渲染 HTML 内容。 | React 组件 (`AppViewer.jsx`) |
| M2.2    | 后端 - 代码生成逻辑    | 优化 "Alex" 智能体的提示 (见 P.1)，使其在被要求时能稳定输出格式化的代码块（HTML/CSS/JS）。 | 更新后的 System Prompt       |
| M2.3    | 数据流 - 代码持久化    | 在 `projects` 集合中增加字段（如 `generatedCode: { html, css, js }`）。当 AI 生成代码时，后端将其解析并保存到 Firestore。 | 后端 API 逻辑                |
| M2.4    | UI - 实时预览数据绑定  | `AppViewer` (iframe) 需要动态加载和渲染 `projects` 文档中的 `generatedCode`。使用 `onSnapshot` 监听 Firestore 变化以实现实时更新。 | `AppViewer.jsx` 功能完善     |
| M2.5    | UI - 文件上传          | 在 `ChatInput` 组件旁添加一个上传按钮。允许用户上传文件（图片、txt 等）。 | `FileUpload.jsx` 组件        |
| M2.6    | 后端 - 文件处理        | 上传的文件存储到 Firebase Storage。在聊天中，将文件引用（如 `#文件名`）插入到发送给 LLM 的 prompt 中。 | `uploadController.js`        |

### M3: “AI 团队” - 多智能体协同框架

*目标: 引入“团队模式”，实现多个 AI 智能体（Mike, Emma, Bob...）的协同工作流。*

| 任务 ID | 任务名称                        | 描述                                                         | 关键产出                           |
| ------- | ------------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| M3.1    | UI - 模式切换                   | 在聊天输入框附近添加一个切换按钮，允许用户在“工程师模式”和“团队模式”之间选择。 | UI 组件                            |
| M3.2    | 智能体提示 (v1.0)               | 为所有 AI 智能体（Mike, Emma, Bob, David, Alex）创建 **v1.0** 的 System Prompt，定义其角色、能力和个性。(持续优化见 P.1) | `agents.js` (包含所有 prompts)     |
| M3.3    | **智能体状态机 (Orchestrator)** | **[核心/高复杂]** 放弃简单的线性调用链。设计一个基于**状态机**的路由逻辑 (Orchestrator)。定义状态 (如 `PLANNING_BY_MIKE`, `DRAFTING_BY_EMMA`, `CODING_BY_ALEX`, `AWAITING_USER_FEEDBACK`)。Mike 的输出将决定下一个状态，Orchestrator 负责路由。必须处理循环（如“修改需求”）和条件分支。 | `teamOrchestrator.js` (状态机逻辑) |
| M3.4    | UI - 智能体状态显示             | 在聊天界面中，明确显示当前是哪个智能体在“思考”或“发言”（例如：显示 Mike 的头像和“正在输入...”）。 | `ChatWindow.jsx` 升级              |
| M3.5    | 聊天历史记录增强                | 聊天记录需要能清晰地展示多智能体之间的对话和协作过程，而不仅仅是 AI 与用户的对话。 | UI 更新                            |

### M4: “高级能力” - 专业模式与核心集成

*目标: 开发“深度研究”、“竞速模式”以及与 GitHub 和 Supabase 的关键集成。*

| 任务 ID | 任务名称                 | 描述                                                         | 关键产出                           |
| ------- | ------------------------ | ------------------------------------------------------------ | ---------------------------------- |
| M4.1    | "深度研究模式" (Iris)    | 添加 "Deep Research" 模式切换。实现 Iris 智能体（M3.2）的 prompt，使其能执行深度信息检索和报告生成。 | UI 切换和 Iris Agent 逻辑          |
| M4.2    | "竞速模式" (Race Mode)   | **[高级]** 添加 "Race Mode" 切换。后端 API 需要并发调用多个 LLM，并实现健壮的**并发处理器，包含对单个模型超时的精细控制和错误聚合逻辑**。 | 后端并发 API 逻辑                  |
| M4.3    | UI - "竞速" 结果选择     | 前端 UI 需要能并排展示 "Race Mode" 的多个结果，并允许用户选择一个“最佳”结果以继续。 | `RaceResultSelector.jsx` 组件      |
| M4.3.5  | **UI - "竞速" 成本警示** | **[新任务]** 在用户激活 'Race Mode' *之前*，实现一个清晰的 UI 提示（如模态框），明确告知这将消耗**多倍**的积分。 | `CreditWarningModal.jsx`           |
| M4.4    | 集成 - GitHub            | 实现 GitHub OAuth 登录。添加“推送到 GitHub”按钮，使用 GitHub API 将 `generatedCode` 创建/更新到用户选择的仓库。 | `githubController.js`              |
| M4.5    | 集成 - Supabase          | 添加“连接 Supabase”功能。更新 Alex (工程师) 的提示 (见 P.1)，使其能够生成与 Supabase (如用户认证、DB 操作) 交互的代码。 | Alex Prompt 更新和 Supabase 连接器 |
| M4.6    | **"辅助 Bug 修复" (v1)** | 在 App Viewer 旁添加“辅助修复”按钮。该按钮获取 `iframe` 中的 console 错误、**用户对问题的自然语言描述**、以及相关的代码片段，一同发送给 Alex。**UI 需管理用户预期**（例如，使用“尝试修复”而非“立即修复”）。 | UI 按钮和后端 API 逻辑             |

### M5: “社区生态” - App World 与分享

*目标: 构建社区功能，允许用户分享、发现和“改造 (Remix)”项目。*

| 任务 ID | 任务名称              | 描述                                                         | 关键产出              |
| ------- | --------------------- | ------------------------------------------------------------ | --------------------- |
| M5.1    | UI - "App World"      | 创建一个新的路由/页面 (`/app-world`)，以卡片形式展示所有“公开”的项目。 | `AppWorld.jsx` 页面   |
| M5.2    | 后端 - 分享与权限     | 在 `projects` 集合中添加 `permission` 字段 (`private`, `link_only`, `public`)。 | Firestore 规则更新    |
| M5.3    | UI - 分享菜单         | 在工作区添加“Share”按钮。弹出一个模态框，允许用户设置权限、复制链接、编辑“App 卡片”（封面、描述）。 | `ShareModal.jsx` 组件 |
| M5.4    | "Remix" 功能          | 在 App World 的项目卡片上添加“Remix”按钮。后端逻辑：复制一个 `project` 文档（包括其聊天记录和代码）并将其分配给当前用户。 | `remixController.js`  |
| M5.5    | "Click to Build" 模板 | 在主页或工作区添加 "Slides", "Blog", "Link Hub" 的快捷按钮。点击后，自动使用一个预设的强大 prompt 启动一个新项目。 | UI 按钮和预设 prompts |

### M6: “正式上线” - 优化与商业化

*目标: 实现积分/订阅系统、优化 Bug 修复和生产环境优化。*

| 任务 ID | 任务名称           | 描述                                                         | 关键产出                   |
| ------- | ------------------ | ------------------------------------------------------------ | -------------------------- |
| M6.1    | 商业化 - 积分系统  | 在 `users` 集合中添加 `credits` 字段。后端在每次调用 LLM API 时，根据模式（Race Mode 消耗更多）和模型消耗积分。 | 后端积分逻辑               |
| M6.2    | 商业化 - 订阅/支付 | 集成 Stripe。创建支付页面，允许用户购买积分包或订阅套餐（如 "Max 套餐" 以解锁 Race Mode）。 | 支付流程和 Stripe Webhooks |
| M6.3    | 部署 - 发布与更新  | 实现 M2.1 中 App Viewer 的“发布 (Publish)”功能，为其生成一个永久的公开 URL。允许用户“更新”已发布的版本。 | `publishController.js`     |
| M6.4    | 部署 - 自定义域名  | **[高级]** 允许付费用户将其发布的项目绑定到自定义域名。      | DNS 配置和服务器路由       |
| M6.5    | 生产优化           | 对前端进行性能优化（代码分割、懒加载），后端进行安全加固，确保所有非功能性需求达标。 | 优化后的代码库             |